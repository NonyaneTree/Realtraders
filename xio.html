<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XIO Assistant</title>
    <meta name="google-adsense-account" content="ca-pub-7221396727211259">
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background: #eef1f5; font-family: 'Segoe UI', sans-serif; min-height: 100vh; overflow-y: auto; }
        .chat-container { width: 100%; min-height: 100vh; display: flex; flex-direction: column; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
        .header { background-color: #0066ff; color: white; padding: 15px 20px; font-size: 18px; font-weight: bold; flex-shrink: 0; position: relative; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; -webkit-overflow-scrolling: touch; }
        .msg { max-width: 85%; padding: 12px 15px; border-radius: 15px; line-height: 1.5; word-break: break-word; display: flex; align-items: flex-start; }
        .msg img.xio-icon { width: 34px; height: 34px; margin-right: 8px; margin-top: 4px; flex-shrink: 0; }
        .user { align-self: flex-end; background: #d7ebff; color: #003366; border-top-right-radius: 0; }
        .xio { align-self: flex-start; background: #f1f1f1; color: #222; border-top-left-radius: 0; }
        .search-container { display: flex; width: 100%; padding: 10px; background: #fff; border-top: 1px solid #ddd; flex-shrink: 0; align-items: center; gap: 8px; }
        #searchInput { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 20px; font-size: 16px; }
        #searchInput:focus { outline: none; border-color: #0066ff; }
        .photo-icon { background: #0066ff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .photo-icon:hover { background: #0055cc; }
        .loading-spinner { border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top: 3px solid #0066ff; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dropdown { position: absolute; right: 10px; top: 10px; }
        .dropbtn { background: none; color: white; font-size: 20px; border: none; cursor: pointer; }
        .dropbtn:hover { color: #ddd; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: white; min-width: 160px; box-shadow: 0px 4px 8px rgba(0,0,0,0.1); z-index: 1; }
        .dropdown-content a { color: #222; padding: 10px 16px; text-decoration: none; display: block; }
        .dropdown-content a:hover { background-color: #f1f1f1; }
        .dropdown:hover .dropdown-content { display: block; }
        .usage-info { text-align: center; padding: 10px; font-size: 14px; color: #666; background: rgba(0, 102, 255, 0.05); border-top: 1px solid #ddd; }
        .pattern-img { max-width: 100%; border-radius: 10px; margin-top: 15px; border: 1px solid #eee; }

        /* Dark theme styles */
        .dark-theme { background: #1e1e1e; color: #fff; }
        .dark-theme .header { background: #222; }
        .dark-theme .msg.user { background: #444; color: white; }
        .dark-theme .msg.xio { background: #333; color: white; }
        .dark-theme .search-container { background: #222; border-top: 1px solid #333; }
        .dark-theme #searchInput { background: #333; border-color: #444; color: #fff; }
        .dark-theme .dropdown-content { background: #333; }
        .dark-theme .dropdown-content a { color: #fff; }
        .dark-theme .dropdown-content a:hover { background: #444; }
        .dark-theme .usage-info { background: rgba(0, 0, 0, 0.2); border-top: 1px solid #333; color: #aaa; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            ðŸ¤– XIO Chat 3.3.4 -- AI Forex Assistant
            <div class="dropdown">
                <button class="dropbtn">â˜°</button>
                <div class="dropdown-content">
                    <a href="pay.html">Payment</a>
                    <a href="fundamental.html">Fundamentals</a>
                    <a href="#">Others</a>
                </div>
            </div>
        </div>
        <div id="messages"></div>
        <div class="usage-info">
            <span id="usageText">You have <strong>5</strong> free queries remaining today. <a href="pay.html">Upgrade to premium</a> for unlimited access.</span>
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Type your question...">
            <button class="photo-icon" onclick="sendMessage()">ðŸ“¤</button>
            <div class="photo-icon" onclick="window.location.href='search.html'">ðŸ“·</div>
        </div>
    </div>

    <script>
        const GENERAL_BOT_TOKEN = 'YOUR_TELEGRAM_BOT_TOKEN';
        const GENERAL_CHAT_ID = 'YOUR_CHAT_ID';
        const synonyms = {};
        const responses = {};
        let qaPairs = [];
        let userPaid = false;
        let dailyLimit = 5;
        let initialized = false;

        // Cookie functions
        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${d.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const cookies = document.cookie.split(';');
            for (let c of cookies) {
                c = c.trim();
                if (c.indexOf(name + "=") === 0) {
                    return c.substring(name.length + 1);
                }
            }
            return null;
        }

        // Payment status check
        async function checkPaymentStatus() {
            try {
                const res = await fetch('pay.html');
                const html = await res.text();
                const match = html.match(/const\s+paymentStatus\s*=\s*{[^}]*paid:\s*(true|false)/);
                if (match && match[1] === "true") {
                    userPaid = true;
                    console.log("User is paid. Unlimited access granted.");
                }
            } catch (err) {
                console.error("Error checking payment:", err);
            }
        }

        // Initialize daily usage limit
        function initDailyLimit() {
            const savedCount = getCookie("xio_usage");
            if (savedCount === null) {
                setCookie("xio_usage", dailyLimit, 1);
                return dailyLimit;
            }
            return parseInt(savedCount, 10);
        }

        // Decrement usage count
        function decrementUsage() {
            let count = parseInt(getCookie("xio_usage"), 10);
            if (count > 0) {
                count--;
                setCookie("xio_usage", count, 1);
            }
            return count;
        }

        // Update usage display
        function updateUsageDisplay() {
            const usageText = document.getElementById("usageText");
            if (userPaid) {
                usageText.innerHTML = "<strong>Premium Account</strong> - Unlimited access";
            } else {
                const remaining = parseInt(getCookie("xio_usage"), 10);
                usageText.innerHTML = `You have <strong>${remaining}</strong> free queries remaining today. <a href="pay.html">Upgrade to premium</a> for unlimited access.`;
            }
        }

        // Main initialization
        async function initialize() {
            await checkPaymentStatus();
            dailyLimit = initDailyLimit();
            await loadSynonyms();
            await loadResponses();
            updateUsageDisplay();
            
            // Add welcome message
            addMessage("XIO", `
                <p>Welcome to XIO Assistant - your AI Forex trading assistant!</p>
                <p>I can help with:</p>
                <ul>
                    <li>Forex trading patterns</li>
                    <li>Technical analysis</li>
                    <li>Risk management</li>
                    <li>Strategy development</li>
                </ul>
                <p>Try asking about: <strong>head and shoulders pattern</strong>, <strong>Fibonacci retracement</strong>, or <strong>candlestick patterns</strong></p>
            `, "xio");
            
            initialized = true;
        }

        // Send message function
        function sendMessage() {
            if (!initialized) {
                addMessage("XIO", "System is still initializing. Please try again in a moment.", "xio");
                return;
            }
            
            if (!userPaid) {
                let remaining = parseInt(getCookie("xio_usage"), 10);
                if (remaining <= 0) {
                    addMessage("XIO", "You've reached your free limit for today. Please <a href='pay.html'>purchase access</a> for unlimited use.", "xio");
                    return;
                }
                decrementUsage();
                updateUsageDisplay();
            }
            
            const input = document.getElementById("searchInput");
            const text = input.value.trim();
            if (!text) return;

            addMessage("You", text, "user");
            const thinkingMsg = addMessage("XIO", "<div class='loading-spinner'></div>", "xio", true);

            setTimeout(async () => {
                thinkingMsg.remove();
                const reply = await getAnswer(text.toLowerCase());
                addMessage("XIO", reply, "xio");
            }, 1000);

            input.value = "";
        }

        // Add message to chat
        function addMessage(sender, text, className, isTemp = false) {
            const messagesDiv = document.getElementById("messages");
            const msgDiv = document.createElement("div");
            msgDiv.className = `msg ${className}`;
            
            // Get current time
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Create message content
            if (className === 'xio') {
                msgDiv.innerHTML = `
                    <img src="https://i.imgur.com/mW7eB2d.png" class="xio-icon" alt="XIO">
                    <div class="msg-content">
                        ${text}
                        <div class="timestamp">${timeString}</div>
                    </div>
                `;
            } else {
                msgDiv.innerHTML = `
                    <div class="msg-content">
                        ${text}
                        <div class="timestamp">${timeString}</div>
                    </div>
                `;
            }
            
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return isTemp ? msgDiv : null;
        }

        // Load synonyms from synonyms.html
        async function loadSynonyms() {
            try {
                const response = await fetch('synonyms.html');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const scriptTag = doc.querySelector('script');

                if (scriptTag && scriptTag.textContent.includes("const forexPatterns")) {
                    const match = scriptTag.textContent.match(/const forexPatterns\s*=\s*(\[[\s\S]*?\]);/);
                    if (match && match[1]) {
                        const patterns = new Function(`return ${match[1]}`)();
                        patterns.forEach(pattern => {
                            synonyms[pattern.title.toLowerCase()] = (pattern.synonyms || []).map(s => s.toLowerCase());
                        });
                        console.log("Synonyms loaded:", synonyms);
                    }
                }
            } catch (err) {
                console.error('Error loading synonyms:', err);
                // Fallback to default synonyms
                synonyms['head and shoulders'] = ['hns', 'head and shoulder', 'head shoulders'];
                synonyms['double top'] = ['double tops', 'dual top', 'm pattern'];
                synonyms['double bottom'] = ['double bottoms', 'dual bottom', 'w pattern'];
                synonyms['triangle'] = ['symmetrical triangle', 'ascending triangle', 'descending triangle'];
                synonyms['fibonacci'] = ['fib retracement', 'fib levels', 'fibonacci retracement'];
                console.log("Using default synonyms");
            }
        }

        // Load responses from xio2.html
        async function loadResponses() {
            try {
                const response = await fetch('xio2.html');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const scriptContent = doc.querySelector('script').textContent;
                const responsesMatch = scriptContent.match(/const responses\s*=\s*({[\s\S]*?});/);
                
                if (responsesMatch && responsesMatch[1]) {
                    const responsesObj = new Function(`return ${responsesMatch[1]}`)();
                    
                    // Clear qaPairs
                    qaPairs = [];
                    
                    for (const [question, data] of Object.entries(responsesObj)) {
                        qaPairs.push({
                            question: question.toLowerCase(),
                            answer: data.description,
                            image: data.image || null,
                            source: 'local'
                        });
                    }
                    console.log("Responses loaded:", qaPairs);
                }
            } catch (error) {
                console.error('Error loading xio2.html:', error);
                // Fallback to default responses
                qaPairs = [
                    {
                        question: "head and shoulders",
                        answer: `
                            <h3>Head and Shoulders Pattern</h3>
                            <p>The Head and Shoulders is a reversal pattern that predicts a bullish-to-bearish trend reversal.</p>
                            <p><strong>Trading Strategy:</strong> Enter short when price breaks below the neckline. Place stop-loss above the right shoulder.</p>
                        `,
                        image: "https://i.imgur.com/7G5Vx9D.png"
                    },
                    {
                        question: "double top",
                        answer: `
                            <h3>Double Top Pattern</h3>
                            <p>The Double Top is a bearish reversal pattern that forms after an uptrend.</p>
                            <p><strong>Trading Strategy:</strong> Enter short when price closes below the neckline. Place stop-loss above the peaks.</p>
                        `,
                        image: "https://i.imgur.com/5tQmZ8d.png"
                    }
                ];
                console.log("Using default responses");
            }
        }

        // Expand input with synonyms
        function expandInputWithSynonyms(input) {
            let expanded = input;
            for (const [key, syns] of Object.entries(synonyms)) {
                if (syns.includes(input)) {
                    expanded = key;
                    break;
                }
            }
            return expanded;
        }

        // Get answer for user input
        async function getAnswer(userInput) {
            if (!qaPairs.length) {
                return "My knowledge base is still loading. Please try again in a moment.";
            }

            const expandedInput = expandInputWithSynonyms(userInput);

            // Look for exact match
            const exactMatch = qaPairs.find(pair => pair.question === expandedInput);
            if (exactMatch) {
                return formatResponse(exactMatch);
            }

            // Look for partial match
            const partialMatches = qaPairs.filter(pair => 
                pair.question.includes(expandedInput) || 
                userInput.includes(pair.question)
            );
            
            if (partialMatches.length > 0) {
                return formatResponse(partialMatches[0]);
            }

            // If no match found
            const availableTopics = [...new Set(qaPairs.map(pair => pair.question))].slice(0, 5).join(", ");
            return `I'm not sure about that. Try asking about: ${availableTopics} or check our Telegram group.`;
        }

        // Format response with image if available
        function formatResponse(pair) {
            let response = pair.answer;
            if (pair.image) {
                response += `<img src="${pair.image}" alt="${pair.question}" class="pattern-img">`;
            }
            return response;
        }

        // Toggle dark theme
        function toggleTheme() {
            document.body.classList.toggle("dark-theme");
            // Save theme preference
            setCookie("xio_theme", document.body.classList.contains("dark-theme") ? "dark" : "light", 30);
        }

        // Apply saved theme preference
        function applySavedTheme() {
            const savedTheme = getCookie("xio_theme");
            if (savedTheme === "dark") {
                document.body.classList.add("dark-theme");
            }
        }

        // Initialize when page loads
        window.onload = function() {
            applySavedTheme();
            initialize();
            
            // Add event listener for Enter key
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        };
    </script>
</body>
</html>
