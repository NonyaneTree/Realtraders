<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XIO Assistant</title>
    <meta name="google-adsense-account" content="ca-pub-7221396727211259">
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background: #eef1f5; font-family: 'Segoe UI', sans-serif; min-height: 100vh; overflow-y: auto; }
        .chat-container { width: 100%; min-height: 100vh; display: flex; flex-direction: column; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
        .header { background-color: #0066ff; color: white; padding: 15px 20px; font-size: 18px; font-weight: bold; flex-shrink: 0; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; -webkit-overflow-scrolling: touch; }
        .msg { max-width: 85%; padding: 12px 15px; border-radius: 15px; line-height: 1.5; word-break: break-word; display: flex; align-items: flex-start; }
        .msg img.xio-icon { width: 34px; height: 34px; margin-right: 8px; margin-top: 4px; flex-shrink: 0; }
        .user { align-self: flex-end; background: #d7ebff; color: #003366; border-top-right-radius: 0; }
        .xio { align-self: flex-start; background: #f1f1f1; color: #222; border-top-left-radius: 0; }
        .search-container { display: flex; width: 100%; padding: 10px; background: #fff; border-top: 1px solid #ddd; flex-shrink: 0; align-items: center; gap: 8px; }
        #searchInput { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 20px; font-size: 16px; }
        #searchInput:focus { outline: none; border-color: #0066ff; }
        .photo-icon { background: #0066ff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .photo-icon:hover { background: #0055cc; }
        .loading-spinner { border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top: 3px solid #0066ff; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dropdown { position: absolute; right: 10px; top: 10px; }
        .dropbtn { background: none; color: white; font-size: 20px; border: none; cursor: pointer; }
        .dropbtn:hover { color: #ddd; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: white; min-width: 160px; box-shadow: 0px 4px 8px rgba(0,0,0,0.1); z-index: 1; }
        .dropdown-content a { color: #222; padding: 10px 16px; text-decoration: none; display: block; }
        .dropdown-content a:hover { background-color: #f1f1f1; }
        .dropdown:hover .dropdown-content { display: block; }

        /* Dark theme styles */
        .dark-theme { background: #1e1e1e; color: #fff; }
        .dark-theme .header { background: #222; }
        .dark-theme .msg.user { background: #444; color: white; }
        .dark-theme .msg.xio { background: #333; color: white; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            ðŸ¤– XIO Chat 3.3.4 -- AI Forex Assistant
            <div class="dropdown">
                <button class="dropbtn">â˜°</button>
                <div class="dropdown-content">
                    <a href="pay.html">Payment</a>
                    <a href="#" onclick="toggleTheme()">Theme</a>
                    <a href="#">Others</a>
                </div>
            </div>
        </div>
        <div id="messages"></div>
        
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Type your question...">
            <div class="photo-icon" onclick="window.location.href='search.html'">ðŸ“·</div>
        </div>
    </div>

    <script>
        const GENERAL_BOT_TOKEN = 'YOUR_TELEGRAM_BOT_TOKEN';
        const GENERAL_CHAT_ID = 'YOUR_CHAT_ID';
        const synonyms = {};
        let userPaid = false;
        let dailyLimit = 5;

        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${d.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const cookies = document.cookie.split(';');
            for (let c of cookies) {
                c = c.trim();
                if (c.indexOf(name + "=") === 0) {
                    return c.substring(name.length + 1);
                }
            }
            return null;
        }

        async function checkPaymentStatus() {
            try {
                const res = await fetch('pay.html');
                const html = await res.text();
                const match = html.match(/const\s+paymentStatus\s*=\s*{[^}]*paid:\s*(true|false)/);
                if (match && match[1] === "true") {
                    userPaid = true;
                    console.log("User is paid. Unlimited access granted.");
                }
            } catch (err) {
                console.error("Error checking payment:", err);
            }
        }

        function initDailyLimit() {
            const savedCount = getCookie("xio_usage");
            if (savedCount === null) {
                setCookie("xio_usage", dailyLimit, 1);
                return dailyLimit;
            }
            return parseInt(savedCount, 10);
        }

        function decrementUsage() {
            let count = parseInt(getCookie("xio_usage"), 10);
            if (count > 0) {
                count--;
                setCookie("xio_usage", count, 1);
            }
            return count;
        }

        async function initialize() {
            await checkPaymentStatus();
            dailyLimit = initDailyLimit();
            await loadSynonyms();
            await searchXio2WithSynonyms();
        }

        function sendMessage() {
            if (!userPaid) {
                let remaining = parseInt(getCookie("xio_usage"), 10);
                if (remaining <= 0) {
                    addMessage("XIO", "You've reached your free limit for today. Please <a href='pay.html'>purchase access</a> for unlimited use.", "xio");
                    return;
                }
                decrementUsage();
            }
            const input = document.getElementById("searchInput");
            const text = input.value.trim();
            if (!text) return;

            addMessage("You", text, "user");
            const thinkingMsg = addMessage("XIO", "<div class='loading-spinner'></div>", "xio", true);

            setTimeout(async () => {
                thinkingMsg.remove();
                const reply = await getAnswer(text.toLowerCase());
                addMessage("XIO", reply, "xio");
            }, 1000);

            input.value = "";
        }

        async function loadSynonyms() {
            try {
                const response = await fetch('synonyms.html');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const scriptTag = doc.querySelector('script');

                if (scriptTag && scriptTag.textContent.includes("const forexPatterns")) {
                    const match = scriptTag.textContent.match(/const forexPatterns\s*=\s*(\[[\s\S]*?\]);/);
                    if (match && match[1]) {
                        const patterns = new Function(`return ${match[1]}`)();
                        patterns.forEach(pattern => {
                            synonyms[pattern.title.toLowerCase()] = (pattern.synonyms || []).map(s => s.toLowerCase());
                        });
                    }
                }
                console.log("Synonyms loaded:", synonyms);
            } catch (err) {
                console.error('Error loading synonyms:', err);
            }
        }

        async function searchXio2WithSynonyms() {
            try {
                const response = await fetch('xio2.html');
                const html = await response.text();

                const results = [];
                for (const [title, synList] of Object.entries(synonyms)) {
                    const allTerms = [title, ...synList];
                    for (const term of allTerms) {
                        const regex = new RegExp(`\\b${term}\\b`, 'i');
                        if (regex.test(html)) {
                            results.push({ match: term, source: 'xio2.html' });
                        }
                    }
                }

                displayResults(results);
            } catch (err) {
                console.error('Error searching xio2.html:', err);
            }
        }

        function displayResults(matches) {
            const outputDiv = document.getElementById("results");
            outputDiv.innerHTML = matches.length
                ? matches.map(m => `<div>Found: <strong>${m.match}</strong> in ${m.source}</div>`).join("")
                : "<div>No matches found</div>";
        }

        function toggleTheme() {
            document.body.classList.toggle("dark-theme");
        }

        async function fetchTelegramMessages() {
            try {
                const response = await fetch(`https://api.telegram.org/bot${GENERAL_BOT_TOKEN}/getUpdates`);
                const data = await response.json();
                if (data.ok && data.result.length > 0) {
                    telegramMessages = data.result
                        .filter(update => update.message && update.message.chat.id.toString() === GENERAL_CHAT_ID)
                        .map(update => ({
                            text: update.message.text,
                            date: new Date(update.message.date * 1000),
                            message_id: update.message.message_id
                        }));
                }
            } catch (error) {
                console.error('Error fetching Telegram messages:', error);
            }
        }

        async function loadResponses() {
            try {
                const response = await fetch('xio2.html');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const scriptContent = doc.querySelector('script').textContent;
                const responsesMatch = scriptContent.match(/const responses = ({[\s\S]*?});/);
                
                if (responsesMatch && responsesMatch[1]) {
                    const responsesObj = new Function(`return ${responsesMatch[1]}`)();
                    Object.assign(responses, responsesObj);
                    
                    for (const [question, data] of Object.entries(responses)) {
                        qaPairs.push({
                            question: question.toLowerCase(),
                            answer: data.description,
                            image: data.image || null,
                            source: 'local'
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading xio2.html:', error);
                addMessage("XIO", "I'm having trouble loading my knowledge base. Please try again later.", "xio");
            }
        }

        function expandInputWithSynonyms(input) {
            let expanded = input;
            for (const [key, syns] of Object.entries(synonyms)) {
                if (syns.includes(input)) {
                    expanded = key;
                    break;
                }
            }
            return expanded;
        }

        async function getAnswer(userInput) {
            if (!qaPairs.length) {
                return "My knowledge base is still loading. Please try again in a moment.";
            }

            const expandedInput = expandInputWithSynonyms(userInput);

            const exactMatch = qaPairs.find(pair => pair.question === expandedInput);
            if (exactMatch) return formatResponse(exactMatch);

            const availableTopics = [...new Set(qaPairs.map(pair => pair.question))].slice(0, 5).join(", ");
            return `I'm not sure about that. Try asking about: ${availableTopics} or check our Telegram group.`;
        }

        function formatResponse(pair) {
            let response = pair.answer;
            if (pair.image) {
                response += `<img src="${pair.image}" alt="${pair.question}" class="pattern-img">`;
            }
            return response;
        }

        // Initialize the application
        window.onload = initialize;
    </script>
</body>
  </html>
